<!DOCTYPE html>
<html lang="nl" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactief Functioneel Ontwerp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Kalm Neutraal Palet -->
    <!-- Application Structure Plan: De applicatie is gestructureerd als een single-page applicatie met een vaste navigatiezijbalk aan de left-kant en een scrollbaar contentgebied aan de rechterkant. Deze dashboard-achtige opzet is gekozen omdat het een directe, duidelijke en vertrouwde manier biedt om door een gestructureerd document zoals een functioneel ontwerp te navigeren. Gebruikers kunnen direct naar elke sectie springen zonder te hoeven scrollen. Interactieve elementen, zoals toggles voor User Stories/Use Cases en uitklapbare secties voor niet-functionele eisen, zijn toegevoegd om de inhoud boeiender en minder overweldigend te maken dan een statische lap tekst. Een bewerkingsfunctionaliteit per sectie, vergelijkbaar met een flat-file CMS, is toegevoegd waarbij wijzigingen lokaal worden opgeslagen in de browser (localStorage). Nu is ook de mogelijkheid toegevoegd om deze lokale data te exporteren als JSON-bestand en te importeren, ter ondersteuning van handmatig beheer via bijvoorbeeld Google Drive. Ten slotte zijn er exportfuncties toegevoegd voor de gehele pagina naar HTML en PDF (via de browser printfunctie). Elk individueel veld is nu apart aanpasbaar, inclusief dynamische rijen in de revisiegeschiedenis, de items in de lijsten onder niet-functionele eisen, en dynamische toevoeging/verwijdering van persona's en entiteiten/attributen in het gegevensmodel. De koppen van de niet-functionele eisen zijn nu gestructureerd als titel/beschrijving blokken, vergelijkbaar met de introductiesectie. De grafiek onder 4.1 Prestatie is verwijderd. Een "ongedaan maken" functionaliteit voor het verwijderen van items en gehele categorieën in de niet-functionele eisen is toegevoegd, inclusief automatisch hernummeren. Alle bewerkbare velden (input/textarea) zijn geoptimaliseerd om de maximale breedte van hun respectievelijke containers te benutten in de bewerkmodus. Specifiek vullen de ERD-tabellen nu de volledige breedte in bewerkmodus. In het gegevensmodel kunnen nu relaties tussen entiteiten worden gedefinieerd en gevisualiseerd met pijlen op een canvas, inclusief labels en richting, die altijd zichtbaar zijn en nu het label direct op de pijl weergeven. Dit bevordert actieve verkenning, personalisatie, basispersistentie en de mogelijkheid tot delen. -->
    <!-- Visualization & Content Choices: 
        - Rapport Info: Template Structuur -> Doel: Navigatie en overzicht -> Presentatie: Vaste zijbalk navigatie -> Interactie: Klik om naar sectie te scrollen -> Rechtvaardiging: Biedt een constant overzicht en snelle toegang, wat essentieel is voor een lang document. Methode: HTML/JS.
        - Rapport Info: Functionaliteit Vergelijken (User Story vs. Use Case) -> Doel: Duidelijke vergelijking en keuze -> Presentatie: Twee aparte, schakelbare contentblokken -> Interactie: Knoppen om te wisselen -> Rechtvaardiging: Vermindert cognitieve belasting en stelt gebruiker in staat om alternatieven te evalueren. Methode: HTML/JS.
        - Rapport Info: Niet-Functionele Eisen -> Doel: Organiseren van subcategorieën en gedetailleerde aanpassing -> Presentatie: Uitklapbare accordeon-elementen. Elke accordion-sectie heeft nu een hoofd-h3-titel en beschrijvende paragraaf die individueel bewerkbaar zijn, vergelijkbaar met de introductiesecties. Daaronder volgen dynamische, bewerkbare lijstitems (toevoegen/verwijderen, inclusief 'ongedaan maken' van laatste verwijdering). Nieuwe functionaliteit: gehele categorieën kunnen worden verwijderd en hernummerd, met een 'ongedaan maken' optie voor categorieën. -> Interactie: Klik om details te tonen/verbergen, inline bewerking van alle tekst, toevoegen/verwijderen van items en categorieën, undo-opties -> Rechtvaardiging: Groepeert gerelateerde informatie compact, maakt gedetailleerde aanpassing van specificaties mogelijk, en biedt flexibiliteit in de organisatiestructuur van NFR's met undo-functionaliteit voor gebruiksgemak. Methode: HTML/JS.
        - Rapport Info: Gegevensmodel (ERD) -> Doel: Gestructureerde weergave van entiteiten en attributen en hun relaties -> Presentatie: Dynamisch gegenereerde entiteitsblokken (tabellen) met bewerkbare titels en attributen, inclusief toevoegen/verwijderen van entiteiten en attributen. Relaties worden gedefinieerd via een formulier en gevisualiseerd als pijlen met labels op een canvas. De pijlen zijn nu *altijd zichtbaar*, ongeacht de bewerkmodus, en tonen het relatie-label direct op de lijn. In edit-modus vullen entiteitstabellen de volledige breedte en worden statische visuele elementen verborgen. -> Interactie: Inline bewerking, toevoegen/verwijderen van entiteiten/attributen, definiëren en verwijderen van relaties -> Rechtvaardiging: Biedt een gestructureerd overzicht van het datamodel en maakt flexibele aanpassing mogelijk van de inhoud en conceptuele relaties, met verbeterde ruimte voor bewerking en een duidelijke, constante visuele representatie van gedefinieerde relaties met inline labels voor betere context. Methode: HTML/CSS/JS voor DOM-manipulatie en Canvas API voor tekenen.
        - Rapport Info: Persona's -> Doel: Gedetailleerde beschrijving en beheer van gebruikersprofielen -> Presentatie: Dynamisch gegenereerde persona-kaarten met bewerkbare velden en acties (toevoegen/verwijderen) -> Interactie: Inline bewerking, toevoegen/verwijderen van persona's -> Rechtvaardiging: Maakt flexibele aanpassing van gebruikersprofielen mogelijk, wat cruciaal is voor projecten met diverse belanghebbenden. Methode: HTML/JS.
        - Bewerken van content -> Doel: Personalisatie en aanpasbaarheid -> Presentatie: Inline bewerkingsvelden (textarea, input) die de volledige breedte van hun container innemen -> Interactie: Bewerkingsknoppen (Edit, Opslaan, Annuleren) en localStorage voor persistentie -> Rechtvaardiging: Verbetert de gebruikerservaring door meer ruimte te bieden voor tekstinvoer en zorgt voor lokale opslag van wijzigingen. Methode: HTML/JS met localStorage.
        - Opslaan/Laden van data -> Doel: Persistentie en mobiliteit van bewerkte content -> Presentatie: Download/Upload knoppen en bestandskiezer -> Interactie: Klik om JSON te downloaden; selecteer JSON om te laden -> Rechtvaardiging: Maakt het mogelijk om de bewerkte template te bewaren en te delen als een discreet bestand, wat de "flat file" aard versterkt en handmatige integratie met cloudopslag zoals Google Drive mogelijk maakt. Methode: HTML/JS met Blob/FileReader.
        - Exporteren van pagina -> Doel: Delen en archiveren van de gehehele content -> Presentatie: Knappen voor PDF en HTML export -> Interactie: Klik om te printen (PDF) of HTML te downloaden -> Rechtvaardiging: Biedt gebruikers de mogelijkheid om de complete, op dat moment zichtbare, content van de applicatie op te slaan in een standaardformaat voor offline gebruik of externe deelplatforms. Methode: window.print() en Blob/URL.createObjectURL.
        - Revisiegeschiedenis tabel bewerking -> Doel: Gedetailleerde content aanpassing van tabulaire data -> Presentatie: Dynamisch gegenereerde tabelrijen met inputvelden en actieknoppen -> Interactie: Klik om rijen toe te voegen/verwijderen, direct bewerken van cellen -> Rechtvaardiging: Maakt fijnmazige controle over de revisiegeschiedenis mogelijk, wat essentieel is voor versiebeheer in een FO. Methode: HTML/JS DOM manipulatie en localStorage.
        - CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
        .erd-table {
            background-color: white;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1rem;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            width: 200px; /* Default width, can be wider in edit mode if content allows */
            min-width: 180px;
            display: inline-block; /* For flexible positioning in flex/grid */
            vertical-align: top; /* Align top when inline-block */
            margin: 10px; /* Spacing between tables */
        }
        .erd-line { /* This class is effectively unused now, but kept for historical context */
            position: absolute;
            background-color: #94a3b8;
            z-index: 0;
        }
        .sidebar-link.active {
            background-color: #e0f2fe;
            color: #0c4a6e;
            font-weight: 600;
        }
        .edit-buttons {
            display: none;
        }
        .edit-mode .edit-buttons {
            display: flex;
        }
        .edit-mode .view-mode-elements {
            display: none;
        }
        .edit-mode .edit-mode-elements {
            display: block;
        }
        .view-mode-elements {
            display: block;
        }
        .edit-mode-elements {
            display: none;
        }
        /* Wider input/textarea in edit mode */
        textarea, input[type="text"], select { /* Added select for consistency */
            @apply w-full p-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500;
        }
        /* Adjust width for table inputs in edit mode */
        .edit-mode table input[type="text"] {
            width: 100%; /* Make table inputs fill cell */
            padding: 0.5rem;
        }
        /* Make ERD tables fill their parent in edit mode */
        .edit-mode .erd-table {
            width: 100%; 
            max-width: none; /* Override any max-width */
        }
        /* Style for the canvas overlay for ERD lines */
        #erd-canvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1; /* Below entities */
        }
        /* Ensure entities are above canvas */
        .erd-table {
            position: relative; /* Ensure z-index works */
            z-index: 10;
        }

        @media print {
            aside, .edit-buttons, .edit-btn, .flex.space-x-2.mb-4, .flex.flex-col.sm\:flex-row.justify-end, 
            .revisie-actions, .persona-actions, .nfr-item-actions, .entity-actions, .attribute-actions, 
            #add-persona-btn, #add-revisie-row, #add-entity-btn, .undo-nfr-item-btn-container,
            #add-nfr-category-btn-container, #relationships-management { /* Hide relationship management in print */
                display: none !important;
            }
            main {
                margin-left: 0 !important;
                width: 100% !important;
            }
            .max-w-4xl {
                max-width: 100% !important;
            }
            table input[type="text"] {
                border: none !important;
                padding: 0 !important;
                background-color: transparent !important;
            }
            ul.list-disc.list-inside li textarea {
                border: none !important;
                padding: 0 !important;
                background-color: transparent !important;
            }
            .edit-mode-elements {
                display: none !important; /* Hide all edit mode elements during print */
            }
            .view-mode-elements {
                display: block !important; /* Ensure view mode elements are visible during print */
            }
            /* Make sure canvas (ERD lines) are visible in print */
            #erd-canvas {
                display: block !important;
            }
            /* Hide static ERD elements during print too, only show dynamic */
            .erd-line.view-mode-elements, .absolute.text-sm.text-slate-600.view-mode-elements {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div class="flex min-h-screen">
        <!-- Sidebar Navigation -->
        <aside class="w-64 bg-white border-r border-slate-200 p-5 fixed top-0 left-0 h-full hidden md:block">
            <h1 class="text-xl font-bold text-sky-800 mb-6">Functioneel Ontwerp</h1>
            <nav id="sidebar-nav" class="space-y-2">
                <a href="#introductie" class="sidebar-link block px-4 py-2 text-sm text-slate-600 hover:bg-slate-100 rounded-md">1. Introductie</a>
                <a href="#overzicht" class="sidebar-link block px-4 py-2 text-sm text-slate-600 hover:bg-slate-100 rounded-md">2. Overzicht</a>
                <a href="#functionele-eisen" class="sidebar-link block px-4 py-2 text-sm text-slate-600 hover:bg-slate-100 rounded-md">3. Functionele Eisen</a>
                <a href="#niet-functionele-eisen" class="sidebar-link block px-4 py-2 text-sm text-slate-600 hover:bg-slate-100 rounded-md">4. Niet-Functionele Eisen</a>
                <a href="#gegevensmodel" class="sidebar-link block px-4 py-2 text-sm text-slate-600 hover:bg-slate-100 rounded-md">5. Gegevensmodel</a>
                <a href="#systeemintegraties" class="sidebar-link block px-4 py-2 text-sm text-slate-600 hover:bg-slate-100 rounded-md">6. Systeemintegraties</a>
                <a href="#ui-ux" class="sidebar-link block px-4 py-2 text-sm text-slate-600 hover:bg-slate-100 rounded-md">7. UI & UX</a>
                <a href="#foutafhandeling" class="sidebar-link block px-4 py-2 text-sm text-slate-600 hover:bg-slate-100 rounded-md">8. Foutafhandeling</a>
                <a href="#testgevallen" class="sidebar-link block px-4 py-2 text-sm text-slate-600 hover:bg-slate-100 rounded-md">9. Testgevallen</a>
                <a href="#open-vragen" class="sidebar-link block px-4 py-2 text-sm text-slate-600 hover:bg-slate-100 rounded-md">10. Open Vragen & Aannames</a>
                <a href="#woordenlijst" class="sidebar-link block px-4 py-2 text-sm text-slate-600 hover:bg-slate-100 rounded-md">11. Woordenlijst</a>
                <a href="#revisiegeschiedenis" class="sidebar-link block px-4 py-2 text-sm text-slate-600 hover:bg-slate-100 rounded-md">12. Revisiegeschiedenis</a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 md:ml-64 p-6 md:p-10">
            <div class="max-w-4xl mx-auto space-y-12">
                <div class="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-2 mb-8">
                    <button id="download-btn" class="px-4 py-2 text-sm font-medium rounded-md bg-blue-600 text-white hover:bg-blue-700">Download Content (JSON)</button>
                    <input type="file" id="upload-input" class="hidden" accept=".json">
                    <button id="upload-btn" class="px-4 py-2 text-sm font-medium rounded-md bg-indigo-600 text-white hover:bg-indigo-700">Upload Content (JSON)</button>
                    <button id="export-html-btn" class="px-4 py-2 text-sm font-medium rounded-md bg-purple-600 text-white hover:bg-purple-700">Export as HTML</button>
                    <button id="print-pdf-btn" class="px-4 py-2 text-sm font-medium rounded-md bg-red-600 text-white hover:bg-red-700">Print / Export as PDF</button>
                </div>

                <!-- Section 1 -->
                <section id="introductie" class="editable-section" data-section-id="introductie">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold border-b border-slate-300 pb-2 flex-grow">1. Introductie</h2>
                        <div class="flex space-x-2 edit-buttons">
                            <button class="save-btn px-3 py-1 text-sm font-medium rounded-md bg-green-600 text-white hover:bg-green-700">Opslaan</button>
                            <button class="cancel-btn px-3 py-1 text-sm font-medium rounded-md bg-red-500 text-white hover:bg-red-600">Annuleren</button>
                        </div>
                        <button class="edit-btn px-3 py-1 text-sm font-medium rounded-md bg-sky-600 text-white hover:bg-sky-700 view-mode-elements">Bewerk</button>
                    </div>
                    <p class="mb-4 text-slate-600 view-mode-elements" data-key="introductie-main-paragraph">Dit is het startpunt van het functioneel ontwerp. In deze sectie wordt het doel, de doelgroep en de scope van het document en de softwareoplossing gedefinieerd. Het legt de basis voor alle volgende secties en zorgt ervoor dat alle belanghebbenden op één lijn zitten.</p>
                    <textarea class="mb-4 edit-mode-elements" data-key="introductie-main-paragraph"></textarea>

                    <div class="space-y-4">
                        <div class="bg-white p-4 rounded-lg border border-slate-200">
                            <h3 class="font-semibold text-slate-700 view-mode-elements" data-key="introductie-1-1-title">1.1 Doel van dit document</h3>
                            <input type="text" class="edit-mode-elements" data-key="introductie-1-1-title">
                            <p class="text-sm text-slate-500 view-mode-elements" data-key="introductie-1-1-description">Beschrijft de functionaliteiten, gedragingen en gebruikersinteracties van de [Naam Software Oplossing]. Dient als specificatie voor ontwikkeling en validatie.</p>
                            <textarea class="text-sm edit-mode-elements" data-key="introductie-1-1-description"></textarea>
                        </div>
                        <div class="bg-white p-4 rounded-lg border border-slate-200">
                            <h3 class="font-semibold text-slate-700 view-mode-elements" data-key="introductie-1-2-title">1.2 Doelgroep</h3>
                            <input type="text" class="edit-mode-elements" data-key="introductie-1-2-title">
                            <p class="text-sm text-slate-500 view-mode-elements" data-key="introductie-1-2-description">Projectmanagers, Analisten, Ontwikkelaars, Testers, Stakeholders.</p>
                            <textarea class="text-sm edit-mode-elements" data-key="introductie-1-2-description"></textarea>
                        </div>
                         <div class="bg-white p-4 rounded-lg border border-slate-200">
                            <h3 class="font-semibold text-slate-700 view-mode-elements" data-key="introductie-1-3-title">1.3 Scope</h3>
                            <input type="text" class="edit-mode-elements" data-key="introductie-1-3-title">
                            <p class="text-sm text-slate-500 view-mode-elements" data-key="introductie-1-3-description">Een korte samenvatting van wat de softwareoplossing wel (in scope) en niet (out of scope) zal doen.</p>
                            <textarea class="text-sm edit-mode-elements" data-key="introductie-1-3-description"></textarea>
                        </div>
                    </div>
                </section>

                <!-- Section 2 -->
                <section id="overzicht" class="editable-section" data-section-id="overzicht">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold border-b border-slate-300 pb-2 flex-grow">2. Overzicht van de Oplossing</h2>
                        <div class="flex space-x-2 edit-buttons">
                            <button class="save-btn px-3 py-1 text-sm font-medium rounded-md bg-green-600 text-white hover:bg-green-700">Opslaan</button>
                            <button class="cancel-btn px-3 py-1 text-sm font-medium rounded-md bg-red-500 text-white hover:bg-red-600">Annuleren</button>
                        </div>
                        <button class="edit-btn px-3 py-1 text-sm font-medium rounded-md bg-sky-600 text-white hover:bg-sky-700 view-mode-elements">Bewerk</button>
                    </div>
                    <p class="mb-4 text-slate-600 view-mode-elements" data-key="overzicht-main-paragraph">Deze sectie geeft een helikopterview van de oplossing. Hier worden de visie, de algemene functionaliteiten en de belangrijkste gebruikers (persona's) beschreven. Dit helpt om de context en de waarde van de software te begrijpen.</p>
                    <textarea class="mb-4 edit-mode-elements" data-key="overzicht-main-paragraph"></textarea>
                    
                    <div class="space-y-4">
                        <div class="bg-white p-4 rounded-lg border border-slate-200">
                            <h3 class="font-semibold text-slate-700 view-mode-elements" data-key="overzicht-2-1-title">2.1 Visie en Missie</h3>
                            <input type="text" class="edit-mode-elements" data-key="overzicht-2-1-title">
                            <p class="text-sm text-slate-500 mt-2 view-mode-elements" data-key="overzicht-2-1-description">Beschrijf hier de overkoepelende visie van de software.</p>
                            <textarea class="text-sm edit-mode-elements" data-key="overzicht-2-1-description"></textarea>

                            <h3 class="font-semibold text-slate-700 mt-4 view-mode-elements" data-key="overzicht-2-2-title">2.2 Algemene Functionaliteit</h3>
                            <input type="text" class="edit-mode-elements" data-key="overzicht-2-2-title">
                            <p class="text-sm text-slate-500 mt-2 view-mode-elements" data-key="overzicht-2-2-description">Geef hier een high-level overzicht van de kernfuncties.</p>
                            <textarea class="text-sm edit-mode-elements" data-key="overzicht-2-2-description"></textarea>
                        </div>

                        <h3 class="font-semibold text-slate-700 mt-4">2.3 Belangrijkste Gebruikers (Persona's)</h3>
                        <div id="personas-container" class="grid md:grid-cols-2 gap-4">
                            <!-- Persona's zullen hier dynamisch geladen worden -->
                        </div>
                        <div class="edit-mode-elements flex justify-center mt-4">
                            <button id="add-persona-btn" class="px-4 py-2 text-sm font-medium rounded-md bg-blue-500 text-white hover:bg-blue-600">Persona Toevoegen</button>
                        </div>
                    </div>
                </section>

                <!-- Section 3 -->
                <section id="functionele-eisen" class="editable-section" data-section-id="functionele-eisen">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold border-b border-slate-300 pb-2 flex-grow">3. Functionele Eisen</h2>
                        <div class="flex space-x-2 edit-buttons">
                            <button class="save-btn px-3 py-1 text-sm font-medium rounded-md bg-green-600 text-white hover:bg-green-700">Opslaan</button>
                            <button class="cancel-btn px-3 py-1 text-sm font-medium rounded-md bg-red-500 text-white hover:bg-red-600">Annuleren</button>
                        </div>
                        <button class="edit-btn px-3 py-1 text-sm font-medium rounded-md bg-sky-600 text-white hover:bg-sky-700 view-mode-elements">Bewerk</button>
                    </div>
                    <p class="mb-4 text-slate-600 view-mode-elements" data-key="functionele-eisen-main-paragraph">Dit is het hart van het functioneel ontwerp. Hier wordt gedetailleerd beschreven *wat* het systeem moet doen. U kunt kiezen tussen User Stories (gericht op gebruikerswaarde) of Use Cases (gericht op interactiestappen). Gebruik de knoppen hieronder om tussen de twee voorbeelden te schakelen.</p>
                    <textarea class="mb-4 edit-mode-elements" data-key="functionele-eisen-main-paragraph"></textarea>
                    
                    <div class="flex space-x-2 mb-4">
                        <button id="show-user-stories" class="px-4 py-2 text-sm font-medium rounded-md bg-sky-600 text-white">Toon User Stories</button>
                        <button id="show-use-cases" class="px-4 py-2 text-sm font-medium rounded-md bg-white border border-slate-300 text-slate-700">Toon Use Cases</button>
                    </div>

                    <div id="user-stories-content">
                        <div class="bg-sky-50 border-l-4 border-sky-500 p-4 rounded-r-lg space-y-4">
                            <h4 class="font-bold view-mode-elements" data-key="us-001-title">US-001: Gebruikersregistratie</h4>
                            <input type="text" class="edit-mode-elements" data-key="us-001-title">
                            <p class="view-mode-elements" data-key="us-001-description">"**Als een** nieuwe gebruiker, **wil ik** mij kunnen registreren, **zodat ik** toegang krijg tot de applicatie."</p>
                            <textarea class="edit-mode-elements" data-key="us-001-description"></textarea>
                            <div>
                                <h5 class="font-semibold view-mode-elements" data-key="us-001-criteria-title">Acceptatiecriteria:</h5>
                                <input type="text" class="edit-mode-elements" data-key="us-001-criteria-title">
                                <ul class="list-disc list-inside text-sm text-slate-600">
                                    <li class="view-mode-elements" data-key="us-001-criteria-1">Uniek e-mailadres is vereist.</li>
                                    <textarea class="edit-mode-elements" data-key="us-001-criteria-1"></textarea>
                                    <li class="view-mode-elements" data-key="us-001-criteria-2">Wachtwoord moet voldoen aan sterkte-eisen.</li>
                                    <textarea class="edit-mode-elements" data-key="us-001-criteria-2"></textarea>
                                    <li class="view-mode-elements" data-key="us-001-criteria-3">Gebruiker ontvangt bevestigingsmail.</li>
                                    <textarea class="edit-mode-elements" data-key="us-001-criteria-3"></textarea>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div id="use-cases-content" class="hidden">
                         <div class="bg-teal-50 border-l-4 border-teal-500 p-4 rounded-r-lg">
                            <h4 class="font-bold view-mode-elements" data-key="uc-001-title">UC-001: Bestelling Plaatsen</h4>
                            <input type="text" class="edit-mode-elements" data-key="uc-001-title">
                            <div class="text-sm space-y-2 mt-2">
                               <p><strong class="text-teal-800 view-mode-elements">Actor:</strong> <span class="view-mode-elements" data-key="uc-001-actor">Klant</span></p>
                               <input type="text" class="edit-mode-elements" data-key="uc-001-actor">

                               <p><strong class="text-teal-800 view-mode-elements">Doel:</strong> <span class="view-mode-elements" data-key="uc-001-goal">Een of meerdere producten bestellen en afrekenen.</span></p>
                               <textarea class="edit-mode-elements" data-key="uc-001-goal"></textarea>
                               <div>
                                   <h5 class="font-semibold view-mode-elements" data-key="uc-001-main-flow-title">Hoofd Stroom:</h5>
                                   <input type="text" class="edit-mode-elements" data-key="uc-001-main-flow-title">
                                   <ol class="list-decimal list-inside text-slate-600">
                                       <li class="view-mode-elements" data-key="uc-001-step-1">Klant navigeert naar winkelwagen.</li>
                                       <textarea class="edit-mode-elements" data-key="uc-001-step-1"></textarea>
                                       <li class="view-mode-elements" data-key="uc-001-step-2">Klant klikt op "Afrekenen".</li>
                                       <textarea class="edit-mode-elements" data-key="uc-001-step-2"></textarea>
                                       <li class="view-mode-elements" data-key="uc-001-step-3">Systeem verwerkt betaling.</li>
                                       <textarea class="edit-mode-elements" data-key="uc-001-step-3"></textarea>
                                       <li class="view-mode-elements" data-key="uc-001-step-4">Systeem genereert orderbevestiging.</li>
                                       <textarea class="edit-mode-elements" data-key="uc-001-step-4"></textarea>
                                   </ol>
                               </div>
                            </div>
                         </div>
                    </div>
                </section>
                
                <!-- Section 4 -->
                <section id="niet-functionele-eisen" class="editable-section" data-section-id="niet-functionele-eisen">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold border-b border-slate-300 pb-2 flex-grow">4. Niet-Functionele Eisen</h2>
                        <div class="flex space-x-2 edit-buttons">
                            <button class="save-btn px-3 py-1 text-sm font-medium rounded-md bg-green-600 text-white hover:bg-green-700">Opslaan</button>
                            <button class="cancel-btn px-3 py-1 text-sm font-medium rounded-md bg-red-500 text-white hover:bg-red-600">Annuleren</button>
                        </div>
                        <button class="edit-btn px-3 py-1 text-sm font-medium rounded-md bg-sky-600 text-white hover:bg-sky-700 view-mode-elements">Bewerk</button>
                    </div>
                    <p class="mb-4 text-slate-600 view-mode-elements" data-key="nfr-main-paragraph">Deze sectie beschrijft *hoe goed* het systeem moet functioneren. Dit omvat aspecten als prestaties, beveiliging en betrouwbaarheid. Deze eisen zijn cruciaal voor de algehele kwaliteit en gebruikerservaring. Klik op de categorieën om de voorbeelden te bekijken.</p>
                    <textarea class="mb-4 edit-mode-elements" data-key="nfr-main-paragraph"></textarea>
                    
                    <div id="nfr-categories-container" class="space-y-2">
                        <!-- NFR categories will be dynamically loaded -->
                    </div>

                    <div id="add-nfr-category-btn-container" class="edit-mode-elements flex flex-col items-center mt-4">
                        <button id="add-nfr-category-btn" class="px-4 py-2 text-sm font-medium rounded-md bg-blue-500 text-white hover:bg-blue-600 mb-2">Nieuwe Categorie Toevoegen</button>
                        <div id="undo-nfr-category-container" class="undo-nfr-item-btn-container hidden">
                            <button id="undo-nfr-category-btn" class="px-3 py-1 text-sm font-medium rounded-md bg-orange-500 text-white hover:bg-orange-600">Maak Categorie Verwijdering Ongedaan</button>
                        </div>
                    </div>
                </section>

                <!-- Section 5 -->
                <section id="gegevensmodel" class="editable-section" data-section-id="gegevensmodel">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold border-b border-slate-300 pb-2 flex-grow">5. Gegevensmodel</h2>
                        <div class="flex space-x-2 edit-buttons">
                            <button class="save-btn px-3 py-1 text-sm font-medium rounded-md bg-green-600 text-white hover:bg-green-700">Opslaan</button>
                            <button class="cancel-btn px-3 py-1 text-sm font-medium rounded-md bg-red-500 text-white hover:bg-red-600">Annuleren</button>
                        </div>
                        <button class="edit-btn px-3 py-1 text-sm font-medium rounded-md bg-sky-600 text-white hover:bg-sky-700 view-mode-elements">Bewerk</button>
                    </div>
                     <p class="mb-4 text-slate-600 view-mode-elements" data-key="gegevensmodel-main-paragraph">Deze sectie definieert de structuur van de data. Het beschrijft de belangrijkste entiteiten (zoals 'Gebruiker' of 'Product') en hoe deze met elkaar in verband staan. De relatie tussen entiteiten kan complex is; in deze weergave worden entiteiten en hun attributen beheerbaar gemaakt. **Let op:** Een complex, visueel schema tekenprogramma zoals Draw.io is niet mogelijk binnen deze enkele HTML-pagina.</p>
                     <textarea class="mb-4 edit-mode-elements" data-key="gegevensmodel-main-paragraph"></textarea>

                     <div id="entities-container" class="relative bg-slate-100 p-8 rounded-lg min-h-96 flex flex-wrap items-start justify-center content-start">
                        <!-- ERD Canvas for drawing relationships -->
                        <canvas id="erd-canvas"></canvas>
                        <!-- Entities will be dynamically loaded -->
                     </div>
                    <div class="edit-mode-elements flex justify-center mt-4">
                        <button id="add-entity-btn" class="px-4 py-2 text-sm font-medium rounded-md bg-blue-500 text-white hover:bg-blue-600">Entiteit Toevoegen</button>
                    </div>

                    <div id="relationships-management" class="edit-mode-elements bg-white p-4 rounded-lg border border-slate-200 mt-8">
                        <h3 class="font-semibold text-slate-700 mb-4">Relaties Beheren</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label for="source-entity" class="block text-sm font-medium text-slate-700">Bron Entiteit:</label>
                                <select id="source-entity" class="mt-1 block w-full p-2 border border-slate-300 rounded-md">
                                    <!-- Options populated by JS -->
                                </select>
                            </div>
                            <div>
                                <label for="target-entity" class="block text-sm font-medium text-slate-700">Doel Entiteit:</label>
                                <select id="target-entity" class="mt-1 block w-full p-2 border border-slate-300 rounded-md">
                                    <!-- Options populated by JS -->
                                </select>
                            </div>
                            <div>
                                <label for="relationship-label" class="block text-sm font-medium text-slate-700">Label (bijv. 1:N):</label>
                                <input type="text" id="relationship-label" class="mt-1 block w-full p-2 border border-slate-300 rounded-md" placeholder="Bijv. 1:N">
                            </div>
                        </div>
                        <button id="add-relationship-btn" class="px-4 py-2 text-sm font-medium rounded-md bg-green-600 text-white hover:bg-green-700">Relatie Toevoegen</button>

                        <h4 class="font-semibold text-slate-700 mt-6 mb-2">Bestaande Relaties:</h4>
                        <ul id="existing-relationships-list" class="space-y-2">
                            <!-- Existing relationships will be listed here -->
                        </ul>
                    </div>
                </section>

                <!-- Other sections would follow a similar pattern -->
                 <section id="systeemintegraties" class="editable-section" data-section-id="systeemintegraties">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold border-b border-slate-300 pb-2 flex-grow">6. Systeemintegraties</h2>
                        <div class="flex space-x-2 edit-buttons">
                            <button class="save-btn px-3 py-1 text-sm font-medium rounded-md bg-green-600 text-white hover:bg-green-700">Opslaan</button>
                            <button class="cancel-btn px-3 py-1 text-sm font-medium rounded-md bg-red-500 text-white hover:bg-red-600">Annuleren</button>
                        </div>
                        <button class="edit-btn px-3 py-1 text-sm font-medium rounded-md bg-sky-600 text-white hover:bg-sky-700 view-mode-elements">Bewerk</button>
                    </div>
                    <p class="mb-4 text-slate-600 view-mode-elements" data-key="systeemintegraties-main-paragraph">Beschrijft de koppelingen met externe systemen, zoals een betalingsprovider of een e-mailsysteem.</p>
                    <textarea class="mb-4 edit-mode-elements" data-key="systeemintegraties-main-paragraph"></textarea>
                </section>
                <section id="ui-ux" class="editable-section" data-section-id="ui-ux">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold border-b border-slate-300 pb-2 flex-grow">7. UI & UX</h2>
                        <div class="flex space-x-2 edit-buttons">
                            <button class="save-btn px-3 py-1 text-sm font-medium rounded-md bg-green-600 text-white hover:bg-green-700">Opslaan</button>
                            <button class="cancel-btn px-3 py-1 text-sm font-medium rounded-md bg-red-500 text-white hover:bg-red-600">Annuleren</button>
                        </div>
                        <button class="edit-btn px-3 py-1 text-sm font-medium rounded-md bg-sky-600 text-white hover:bg-sky-700 view-mode-elements">Bewerk</button>
                    </div>
                     <p class="mb-4 text-slate-600 view-mode-elements" data-key="ui-ux-main-paragraph">Bevat richtlijnen voor het ontwerp en de gebruikerservaring, inclusief verwijzingen naar wireframes.</p>
                     <textarea class="mb-4 edit-mode-elements" data-key="ui-ux-main-paragraph"></textarea>
                </section>
                <section id="foutafhandeling" class="editable-section" data-section-id="foutafhandeling">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold border-b border-slate-300 pb-2 flex-grow">8. Foutafhandeling</h2>
                        <div class="flex space-x-2 edit-buttons">
                            <button class="save-btn px-3 py-1 text-sm font-medium rounded-md bg-green-600 text-white hover:bg-green-700">Opslaan</button>
                            <button class="cancel-btn px-3 py-1 text-sm font-medium rounded-md bg-red-500 text-white hover:bg-red-600">Annuleren</button>
                        </div>
                        <button class="edit-btn px-3 py-1 text-sm font-medium rounded-md bg-sky-600 text-white hover:bg-sky-700 view-mode-elements">Bewerk</button>
                    </div>
                     <p class="mb-4 text-slate-600 view-mode-elements" data-key="foutafhandeling-main-paragraph">Definieert hoe het systeem reageert op fouten, zowel gebruikersfouten als technische problemen.</p>
                     <textarea class="mb-4 edit-mode-elements" data-key="foutafhandeling-main-paragraph"></textarea>
                </section>
                <section id="testgevallen" class="editable-section" data-section-id="testgevallen">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold border-b border-slate-300 pb-2 flex-grow">9. Testgevallen</h2>
                        <div class="flex space-x-2 edit-buttons">
                            <button class="save-btn px-3 py-1 text-sm font-medium rounded-md bg-green-600 text-white hover:bg-green-700">Opslaan</button>
                            <button class="cancel-btn px-3 py-1 text-sm font-medium rounded-md bg-red-500 text-white hover:bg-red-600">Annuleren</button>
                        </div>
                        <button class="edit-btn px-3 py-1 text-sm font-medium rounded-md bg-sky-600 text-white hover:bg-sky-700 view-mode-elements">Bewerk</button>
                    </div>
                    <p class="mb-4 text-slate-600 view-mode-elements" data-key="testgevallen-main-paragraph">Een lijst met voorlopige testscenario's om de functionaliteit te valideren.</p>
                    <textarea class="mb-4 edit-mode-elements" data-key="testgevallen-main-paragraph"></textarea>
                </section>
                <section id="open-vragen" class="editable-section" data-section-id="open-vragen">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold border-b border-slate-300 pb-2 flex-grow">10. Open Vragen & Aannames</h2>
                        <div class="flex space-x-2 edit-buttons">
                            <button class="save-btn px-3 py-1 text-sm font-medium rounded-md bg-green-600 text-white hover:bg-green-700">Opslaan</button>
                            <button class="cancel-btn px-3 py-1 text-sm font-medium rounded-md bg-red-500 text-white hover:bg-red-600">Annuleren</button>
                        </div>
                        <button class="edit-btn px-3 py-1 text-sm font-medium rounded-md bg-sky-600 text-white hover:bg-sky-700 view-mode-elements">Bewerk</button>
                    </div>
                    <p class="mb-4 text-slate-600 view-mode-elements" data-key="open-vragen-main-paragraph">Een overzicht van onduidelijkheden en de aannames die zijn gemaakt tijdens het opstellen van het document.</p>
                    <textarea class="mb-4 edit-mode-elements" data-key="open-vragen-main-paragraph"></textarea>
                </section>
                 <section id="woordenlijst" class="editable-section" data-section-id="woordenlijst">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold border-b border-slate-300 pb-2 flex-grow">11. Woordenlijst</h2>
                        <div class="flex space-x-2 edit-buttons">
                            <button class="save-btn px-3 py-1 text-sm font-medium rounded-md bg-green-600 text-white hover:bg-green-700">Opslaan</button>
                            <button class="cancel-btn px-3 py-1 text-sm font-medium rounded-md bg-red-500 text-white hover:bg-red-600">Annuleren</button>
                        </div>
                        <button class="edit-btn px-3 py-1 text-sm font-medium rounded-md bg-sky-600 text-white hover:bg-sky-700 view-mode-elements">Bewerk</button>
                    </div>
                    <p class="mb-4 text-slate-600 view-mode-elements" data-key="woordenlijst-main-paragraph">Definities van specifieke termen om eenduidigheid te garanderen.</p>
                    <textarea class="mb-4 edit-mode-elements" data-key="woordenlijst-main-paragraph"></textarea>
                </section>
                <section id="revisiegeschiedenis" class="editable-section" data-section-id="revisiegeschiedenis">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold border-b border-slate-300 pb-2 flex-grow">12. Revisiegeschiedenis</h2>
                        <div class="flex space-x-2 edit-buttons">
                            <button class="save-btn px-3 py-1 text-sm font-medium rounded-md bg-green-600 text-white hover:bg-green-700">Opslaan</button>
                            <button class="cancel-btn px-3 py-1 text-sm font-medium rounded-md bg-red-500 text-white hover:bg-red-600">Annuleren</button>
                        </div>
                        <button class="edit-btn px-3 py-1 text-sm font-medium rounded-md bg-sky-600 text-white hover:bg-sky-700 view-mode-elements">Bewerk</button>
                    </div>
                    <p class="mb-4 text-slate-600 view-mode-elements" data-key="revisiegeschiedenis-main-paragraph">Een logboek van wijzigingen aan het document.</p>
                    <textarea class="mb-4 edit-mode-elements" data-key="revisiegeschiedenis-main-paragraph"></textarea>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white text-sm rounded-lg border border-slate-200">
                            <thead class="bg-slate-100">
                                <tr>
                                    <th class="p-3 text-left font-semibold">Versie</th>
                                    <th class="p-3 text-left font-semibold">Datum</th>
                                    <th class="p-3 text-left font-semibold">Auteur</th>
                                    <th class="p-3 text-left font-semibold">Beschrijving</th>
                                    <th class="p-3 text-left font-semibold edit-mode-elements revisie-actions">Acties</th>
                                </tr>
                            </thead>
                            <tbody id="revisie-table-body-view" class="view-mode-elements">
                                <!-- Content will be dynamically loaded/rendered by JS -->
                            </tbody>
                            <tbody id="revisie-table-body-edit" class="edit-mode-elements">
                                <!-- Content will be dynamically loaded/rendered by JS -->
                            </tbody>
                        </table>
                        <div class="edit-mode-elements flex justify-center mt-4">
                            <button id="add-revisie-row" class="px-4 py-2 text-sm font-medium rounded-md bg-blue-500 text-white hover:bg-blue-600">Rij Toevoegen</button>
                        </div>
                    </div>
                </section>

            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let dataStore = JSON.parse(localStorage.getItem('foTemplateData')) || {};
            let originalSectionData = {}; 
            let lastDeletedNfrItem = null; // Stores {nfrKey, index, itemContent} for NFR list items undo
            let lastDeletedNfrCategory = null; // Stores {index, categoryObject} for NFR category undo

            // Standaard data initialisatie indien nog niet in localStorage
            if (!dataStore['revisiegeschiedenis-data']) {
                dataStore['revisiegeschiedenis-data'] = [
                    { version: '0.1', date: '01-01-2023', author: 'Initial', description: 'Eerste concept' },
                    { version: '1.0', date: '15-01-2023', author: 'Final', description: 'Definitieve versie' }
                ];
            }
            if (!dataStore['personas-data']) {
                dataStore['personas-data'] = [
                    { name: 'Anna, de Projectmanager', goals: 'Duidelijk overzicht van projectstatus en voortgang van taken.', painpoints: 'Moeite met consolideren van informatie uit verschillende systemen, wat leidt tot vertragingen.' }
                ];
            }
            // Initialize NFR categories as an array of objects
            if (!dataStore['nfr-categories']) {
                dataStore['nfr-categories'] = [
                    { 
                        title: 'Prestatie', 
                        description: 'Eisen met betrekking tot snelheid en schaalbaarheid.', 
                        items: ['**Responsietijden:** Pagina\'s laden binnen 2 seconden.', '**Schaalbaarheid:** Systeem ondersteunt 500 gelijktijdige gebruikers.'] 
                    },
                    { 
                        title: 'Beveiliging', 
                        description: 'Eisen om het systeem en de data te beschermen.', 
                        items: ['**Authenticatie:** Multi-factor authenticatie is verplicht voor beheerders.', '**Autorisatie:** Gebruikers hebben alleen toegang tot hun eigen data.', '**Gegevensversleuteling:** Gevoelige data wordt versleuteld opgeslagen (at-rest).'] 
                    },
                    { 
                        title: 'Beschikbaarheid en Betrouwbaarheid', 
                        description: 'Eisen met betrekking tot beschikbaarheid en herstel.', 
                        items: ['**Uptime:** Het systeem moet minimaal 99.9% van de tijd beschikbaar zijn.', '**Herstel:** Hersteltijd (RTO) van maximaal 4 uur in geval van storing.', '**Gegevensverlies:** Maximaal gegevensverlies (RPO) van 5 minuten.'] 
                    },
                    { 
                        title: 'Bruikbaarheid (Usability)', 
                        description: 'Eisen met betrekking tot gebruikersgemak.', 
                        items: ['**Consistentie:** Consistente gebruikersinterface en navigatie.', '**Toegankelijkheid:** Voldoen aan WCAG 2.1 AA.', '**Feedback:** Duidelijke feedback aan de gebruiker over systeemstatus en acties.'] 
                    },
                    { 
                        title: 'Onderhoudbaarheid', 
                        description: 'Eisen met betrekking tot beheer en uitbreiding.', 
                        items: ['**Modulariteit:** Het systeem moet modulair zijn opgebouwd voor eenvoudig onderhoud en uitbreiding.', '**Documentatie:** Broncode moet goed gedocumenteerd zijn.'] 
                    },
                    { 
                        title: 'Compatibiliteit', 
                        description: 'Eisen met betrekking tot compatibiliteit met browsers, apparaten en besturingssystemen.', 
                        items: ['**Browsers:** Ondersteuning voor Chrome, Firefox, Edge (laatste 2 versies).', '**Apparaten:** Responsief ontwerp voor desktop, tablet en mobiel.', '**Besturingssystemen:** Compatibiliteit met Windows, macOS, iOS, Android.'] 
                    }
                ];
            }

            if (!dataStore['gegevensmodel-entities']) {
                dataStore['gegevensmodel-entities'] = [
                    { id: 'gebruiker', title: 'Gebruiker', attributes: ['<strong>gebruiker_id (PK)</strong>', 'naam', 'email', 'wachtwoord_hash', 'registratiedatum'] },
                    { id: 'product', title: 'Product', attributes: ['<strong>product_id (PK)</strong>', 'naam', 'beschrijving', 'prijs', '<em>categorie_id (FK)</em>'] },
                    { id: 'bestelling', title: 'Bestelling', attributes: ['<strong>bestelling_id (PK)</strong>', '<em>gebruiker_id (FK)</em>', 'besteldatum', 'totaalprijs', 'status'] }
                ];
            }
            // New: Initialize relationships
            if (!dataStore['gegevensmodel-relationships']) {
                dataStore['gegevensmodel-relationships'] = [
                    { source: 'gebruiker', target: 'bestelling', label: '1:N', bidirectional: false },
                    { source: 'bestelling', target: 'product', label: 'N:M', bidirectional: true } // Example of bidirectional
                ];
            }


            // Functie om content te laden vanuit dataStore (localStorage)
            const loadContent = () => {
                document.querySelectorAll('[data-key]').forEach(element => {
                    const key = element.dataset.key;
                    // Skip dynamic list items and NFR titles as they are rendered by dedicated functions
                    if (key.startsWith('revisie-') || key.startsWith('persona-') || key.includes('-item-') || key.startsWith('entity-') || key.includes('-category-')) {
                        return;
                    }
                    if (dataStore[key] !== undefined) { 
                        if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                            element.value = dataStore[key];
                        } else {
                            element.innerHTML = dataStore[key];
                        }
                    }
                });
                renderRevisieTable('view'); 
                renderPersonas('view');
                renderNFRCategories('view'); // Render all NFR categories
                renderEntities('view'); // This now calls drawRelationships
                populateRelationshipDropdowns(); // Update dropdowns when entities change
                renderRelationshipsList(); // Render the list of relationships
            };

            // Functie om revisiegeschiedenis tabel te renderen
            const renderRevisieTable = (mode) => {
                const tbodyView = document.getElementById('revisie-table-body-view');
                const tbodyEdit = document.getElementById('revisie-table-body-edit');
                
                tbodyView.innerHTML = '';
                tbodyEdit.innerHTML = '';

                dataStore['revisiegeschiedenis-data'].forEach((row, index) => {
                    // View Mode Row
                    const trView = document.createElement('tr');
                    trView.className = 'border-t';
                    trView.innerHTML = `
                        <td class="p-3 view-mode-elements" data-key="revisie-${index}-version">${row.version}</td>
                        <td class="p-3 view-mode-elements" data-key="revisie-${index}-date">${row.date}</td>
                        <td class="p-3 view-mode-elements" data-key="revisie-${index}-author">${row.author}</td>
                        <td class="p-3 view-mode-elements" data-key="revisie-${index}-description">${row.description}</td>
                    `;
                    tbodyView.appendChild(trView);

                    // Edit Mode Row
                    const trEdit = document.createElement('tr');
                    trEdit.className = 'border-t';
                    trEdit.innerHTML = `
                        <td class="p-3"><input type="text" data-key="revisie-${index}-version" value="${row.version}"></td>
                        <td class="p-3"><input type="text" data-key="revisie-${index}-date" value="${row.date}"></td>
                        <td class="p-3"><input type="text" data-key="revisie-${index}-author" value="${row.author}"></td>
                        <td class="p-3"><input type="text" data-key="revisie-${index}-description" value="${row.description}"></td>
                        <td class="p-3 revisie-actions"><button class="delete-revisie-row px-3 py-1 text-sm font-medium rounded-md bg-red-500 text-white hover:bg-red-600" data-index="${index}">Verwijder</button></td>
                    `;
                    tbodyEdit.appendChild(trEdit);
                });

                if (mode === 'edit') {
                    tbodyEdit.querySelectorAll('.delete-revisie-row').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const indexToDelete = parseInt(e.target.dataset.index);
                            dataStore['revisiegeschiedenis-data'].splice(indexToDelete, 1);
                            renderRevisieTable('edit'); 
                        });
                    });
                }
            };

            // Functie om persona's te renderen
            const renderPersonas = (mode) => {
                const container = document.getElementById('personas-container');
                container.innerHTML = ''; 

                dataStore['personas-data'].forEach((persona, index) => {
                    const personaDiv = document.createElement('div');
                    personaDiv.className = 'bg-white p-4 rounded-lg border border-slate-200';
                    personaDiv.innerHTML = `
                        <h3 class="font-semibold text-slate-700 view-mode-elements">Persona ${index + 1}</h3>
                        <input type="text" class="edit-mode-elements mb-2" data-key="persona-${index}-title" value="Persona ${index + 1}">
                        <p class="text-sm font-medium text-sky-700 mt-2 view-mode-elements">Naam:</p>
                        <p class="text-sm text-slate-500 view-mode-elements" data-key="persona-${index}-name">${persona.name}</p>
                        <input type="text" class="edit-mode-elements" data-key="persona-${index}-name" value="${persona.name}">

                        <p class="text-sm font-medium text-sky-700 mt-2 view-mode-elements">Doelen:</p>
                        <p class="text-sm text-slate-500 view-mode-elements" data-key="persona-${index}-goals">${persona.goals}</p>
                        <textarea class="text-sm edit-mode-elements" data-key="persona-${index}-goals">${persona.goals}</textarea>

                        <p class="text-sm font-medium text-sky-700 mt-2 view-mode-elements">Pijnpunten:</p>
                        <p class="text-sm text-slate-500 view-mode-elements" data-key="persona-${index}-painpoints">${persona.painpoints}</p>
                        <textarea class="text-sm edit-mode-elements" data-key="persona-${index}-painpoints">${persona.painpoints}</textarea>
                        ${mode === 'edit' ? `<div class="persona-actions flex justify-end mt-4"><button class="delete-persona-btn px-3 py-1 text-sm font-medium rounded-md bg-red-500 text-white hover:bg-red-600" data-index="${index}">Verwijder</button></div>` : ''}
                    `;
                    container.appendChild(personaDiv);
                });

                if (mode === 'edit') {
                    container.querySelectorAll('.delete-persona-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const indexToDelete = parseInt(e.target.dataset.index);
                            dataStore['personas-data'].splice(indexToDelete, 1);
                            renderPersonas('edit'); 
                        });
                    });
                }
            };

            // Functie om NFR categorieën te renderen
            const renderNFRCategories = (mode) => {
                const container = document.getElementById('nfr-categories-container');
                container.innerHTML = ''; 
                lastDeletedNfrCategory = null; // Reset for category undo on re-render

                dataStore['nfr-categories'].forEach((category, catIndex) => {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'bg-white p-4 rounded-lg border border-slate-200';
                    categoryDiv.setAttribute('data-nfr-category-index', catIndex); // Store index for easy lookup

                    // Calculate display number
                    const displayNum = `4.${catIndex + 1}`;

                    categoryDiv.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-semibold text-slate-700 view-mode-elements flex-grow" data-key="nfr-category-${catIndex}-title-view">${displayNum} ${category.title}</h3>
                            <input type="text" class="edit-mode-elements flex-grow mr-2" data-key="nfr-category-${catIndex}-title-edit" value="${category.title}">
                            <button class="accordion-toggle px-3 py-1 text-sm font-medium rounded-md bg-slate-200 text-slate-700 hover:bg-slate-300 transform transition-transform">
                                <span class="accordion-icon">▼</span>
                            </button>
                            ${mode === 'edit' ? `<button class="delete-nfr-category-btn px-3 py-1 text-sm font-medium rounded-md bg-red-500 text-white hover:bg-red-600 ml-2 edit-mode-elements" data-nfr-category-index="${catIndex}">Verwijder Categorie</button>` : ''}
                        </div>
                        <div class="accordion-content hidden">
                            <p class="text-sm text-slate-600 mb-2 view-mode-elements" data-key="nfr-category-${catIndex}-description">${category.description}</p>
                            <textarea class="text-sm edit-mode-elements" data-key="nfr-category-${catIndex}-description">${category.description}</textarea>
                            <ul id="nfr-category-${catIndex}-items-list-view" class="list-disc list-inside text-sm text-slate-500 view-mode-elements">
                                <!-- Items will be dynamically loaded -->
                            </ul>
                            <ul id="nfr-category-${catIndex}-items-list-edit" class="list-disc list-inside text-sm text-slate-500 edit-mode-elements">
                                <!-- Items will be dynamically loaded -->
                            </ul>
                            <div class="edit-mode-elements flex flex-col items-center mt-2">
                                <button class="add-nfr-item-btn px-3 py-1 text-sm font-medium rounded-md bg-blue-500 text-white hover:bg-blue-600 mb-2" data-nfr-category-index="${catIndex}">Item Toevoegen</button>
                                <div id="undo-nfr-item-${catIndex}-container" class="undo-nfr-item-btn-container hidden">
                                    <button class="undo-nfr-item-btn px-3 py-1 text-sm font-medium rounded-md bg-orange-500 text-white hover:bg-orange-600" data-nfr-category-index="${catIndex}">Maak Verwijdering Ongedaan</button>
                                </div>
                            </div>
                        </div>
                    `;
                    container.appendChild(categoryDiv);

                    // Render items for this category
                    renderNFRItemsList(catIndex, mode);
                });

                if (mode === 'edit') {
                    // Attach event listeners for dynamic buttons
                    container.querySelectorAll('.delete-nfr-category-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const indexToDelete = parseInt(e.target.dataset.nfrCategoryIndex);
                            lastDeletedNfrCategory = {
                                index: indexToDelete,
                                category: JSON.parse(JSON.stringify(dataStore['nfr-categories'][indexToDelete])) // Deep copy
                            };
                            document.getElementById('undo-nfr-category-container').classList.remove('hidden');

                            dataStore['nfr-categories'].splice(indexToDelete, 1);
                            renderNFRCategories('edit'); // Re-render to update numbering and listeners
                        });
                    });

                    document.getElementById('undo-nfr-category-btn').addEventListener('click', () => {
                        if (lastDeletedNfrCategory) {
                            const { index, category } = lastDeletedNfrCategory;
                            dataStore['nfr-categories'].splice(index, 0, category);
                            renderNFRCategories('edit');
                            lastDeletedNfrCategory = null;
                            document.getElementById('undo-nfr-category-container').classList.add('hidden');
                        }
                    }, { once: true }); // Ensure it only fires once until next delete

                    container.querySelectorAll('.add-nfr-item-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const catIndex = parseInt(e.target.dataset.nfrCategoryIndex);
                            dataStore['nfr-categories'][catIndex].items.push(''); 
                            renderNFRItemsList(catIndex, 'edit');
                        });
                    });

                    container.querySelectorAll('.accordion-toggle').forEach(toggle => {
                        toggle.addEventListener('click', (e) => {
                            const content = e.target.closest('.flex.justify-between.items-center.mb-2').nextElementSibling;
                            const icon = toggle.querySelector('.accordion-icon');
                            content.classList.toggle('hidden');
                            icon.classList.toggle('rotate-180');
                        });
                    });
                }
            };

            // Functie om NFR itemslijsten te renderen (nu binnen een specifieke categorie-index)
            const renderNFRItemsList = (catIndex, mode) => {
                const category = dataStore['nfr-categories'][catIndex];
                if (!category) return; // Category might have been deleted

                const listView = document.getElementById(`nfr-category-${catIndex}-items-list-view`);
                const listEdit = document.getElementById(`nfr-category-${catIndex}-items-list-edit`);
                const undoButtonContainer = document.getElementById(`undo-nfr-item-${catIndex}-container`);
                
                if (!listView || !listEdit) return; 

                listView.innerHTML = '';
                listEdit.innerHTML = '';

                category.items.forEach((item, itemIndex) => {
                    // View Mode
                    const liView = document.createElement('li');
                    liView.className = 'view-mode-elements';
                    liView.innerHTML = item;
                    listView.appendChild(liView);

                    // Edit Mode
                    const liEdit = document.createElement('li');
                    liEdit.className = 'edit-mode-elements flex items-center mb-1';
                    liEdit.innerHTML = `
                        <textarea class="w-full text-sm mr-2" data-key="nfr-category-${catIndex}-item-${itemIndex}-edit">${item}</textarea>
                        <button class="delete-nfr-item-btn px-2 py-1 text-sm font-medium rounded-md bg-red-500 text-white hover:bg-red-600 flex-shrink-0" data-nfr-category-index="${catIndex}" data-item-index="${itemIndex}">-</button>
                    `;
                    listEdit.appendChild(liEdit);
                });

                if (mode === 'edit') {
                    listEdit.querySelectorAll('.delete-nfr-item-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const currentCatIndex = parseInt(e.target.dataset.nfrCategoryIndex);
                            const indexToDelete = parseInt(e.target.dataset.itemIndex);
                            
                            // Store for undo
                            lastDeletedNfrItem = {
                                nfrKey: currentCatIndex, // This is now the category index
                                index: indexToDelete,
                                itemContent: dataStore['nfr-categories'][currentCatIndex].items[indexToDelete]
                            };
                            undoButtonContainer.classList.remove('hidden');

                            dataStore['nfr-categories'][currentCatIndex].items.splice(indexToDelete, 1);
                            renderNFRItemsList(currentCatIndex, 'edit');
                        });
                    });

                    // Undo for individual items
                    if (undoButtonContainer) {
                        const undoBtn = undoButtonContainer.querySelector('.undo-nfr-item-btn');
                        if (undoBtn) {
                            undoBtn.onclick = (e) => { // Use onclick to easily overwrite previous listeners
                                if (lastDeletedNfrItem && lastDeletedNfrItem.nfrKey === catIndex) {
                                    const { nfrKey, index, itemContent } = lastDeletedNfrItem;
                                    dataStore['nfr-categories'][nfrKey].items.splice(index, 0, itemContent); 
                                    renderNFRItemsList(nfrKey, 'edit');
                                    lastDeletedNfrItem = null; 
                                    e.target.parentElement.classList.add('hidden'); 
                                }
                            };
                        }
                    }
                }
            };


            // Functie om entiteiten (gegevensmodel) te renderen
            const renderEntities = (mode) => {
                const container = document.getElementById('entities-container');
                container.innerHTML = ''; // Clear existing content
                
                // Set container styling based on mode for responsiveness
                if (mode === 'view') {
                    container.classList.remove('flex-col', 'items-start', 'justify-start');
                    container.classList.add('flex-wrap', 'justify-center', 'items-start');
                    container.style.height = 'auto'; // Let height adjust to content
                } else { // Edit mode
                    container.classList.remove('flex-wrap', 'justify-center', 'items-start');
                    container.classList.add('flex-col', 'items-start', 'justify-start'); // Stack vertically for easier editing
                    container.style.height = 'auto'; // Ensure it can expand
                }

                dataStore['gegevensmodel-entities'].forEach((entity) => {
                    const entityDiv = document.createElement('div');
                    entityDiv.className = 'erd-table relative';
                    entityDiv.setAttribute('data-entity-id', entity.id); 
                    entityDiv.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-bold border-b pb-1 flex-grow view-mode-elements" data-key="entity-${entity.id}-title">${entity.title}</h4>
                            <input type="text" class="edit-mode-elements flex-grow mr-2" data-key="entity-${entity.id}-title" value="${entity.title}">
                            ${mode === 'edit' ? `<button class="delete-entity-btn px-2 py-1 text-sm font-medium rounded-md bg-red-500 text-white hover:bg-red-600 flex-shrink-0" data-entity-id="${entity.id}">X</button>` : ''}
                        </div>
                        <ul class="text-sm text-slate-600" id="entity-${entity.id}-attributes-${mode}">
                            <!-- Attributes will be loaded dynamically -->
                        </ul>
                        ${mode === 'edit' ? `
                            <div class="edit-mode-elements flex justify-center mt-2 attribute-actions">
                                <button class="add-attribute-btn px-3 py-1 text-sm font-medium rounded-md bg-blue-500 text-white hover:bg-blue-600" data-entity-id="${entity.id}">Rij Toevoegen</button>
                            </div>
                        ` : ''}
                    `;
                    container.appendChild(entityDiv);

                    // Render attributes for this entity
                    const attributesList = entityDiv.querySelector(`#entity-${entity.id}-attributes-${mode}`);
                    entity.attributes.forEach((attr, attrIndex) => {
                        const li = document.createElement('li');
                        li.className = 'flex items-center mb-1';
                        if (mode === 'view') {
                            li.className += ' view-mode-elements';
                            li.innerHTML = attr;
                        } else { // edit mode
                            li.className += ' edit-mode-elements';
                            li.innerHTML = `
                                <input type="text" class="w-full text-sm mr-2" data-key="entity-${entity.id}-attribute-${attrIndex}" value="${attr}">
                                <button class="delete-attribute-btn px-2 py-1 text-sm font-medium rounded-md bg-red-500 text-white hover:bg-red-600 flex-shrink-0" data-entity-id="${entity.id}" data-attribute-index="${attrIndex}">-</button>
                            `;
                        }
                        attributesList.appendChild(li);
                    });
                });
                drawRelationships(); // Always draw relationships after rendering entities

                if (mode === 'edit') {
                    container.querySelectorAll('.delete-entity-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const entityIdToDelete = e.target.dataset.entityId;
                            dataStore['gegevensmodel-entities'] = dataStore['gegevensmodel-entities'].filter(e => e.id !== entityIdToDelete);
                            // Also remove related relationships
                            dataStore['gegevensmodel-relationships'] = dataStore['gegevensmodel-relationships'].filter(rel => 
                                rel.source !== entityIdToDelete && rel.target !== entityIdToDelete
                            );
                            renderEntities('edit'); 
                            populateRelationshipDropdowns(); 
                            renderRelationshipsList(); 
                        });
                    });

                    container.querySelectorAll('.add-attribute-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const entityId = e.target.dataset.entityId;
                            const entity = dataStore['gegevensmodel-entities'].find(e => e.id === entityId);
                            if (entity) {
                                entity.attributes.push(''); 
                                renderEntities('edit'); 
                            }
                        });
                    });

                    container.querySelectorAll('.delete-attribute-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const entityId = e.target.dataset.entityId;
                            const attributeIndexToDelete = parseInt(e.target.dataset.attributeIndex);
                            const entity = dataStore['gegevensmodel-entities'].find(e => e.id === entityId);
                            if (entity) {
                                entity.attributes.splice(attributeIndexToDelete, 1);
                                renderEntities('edit'); 
                            }
                        });
                    });
                }
            };

            // Functie om relaties te tekenen op de canvas
            const drawRelationships = () => {
                const canvas = document.getElementById('erd-canvas');
                const container = document.getElementById('entities-container');
                if (!canvas || !container) return;

                // Set canvas dimensions to match container
                canvas.width = container.offsetWidth;
                canvas.height = container.offsetHeight;

                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear canvas

                ctx.strokeStyle = '#3b82f6'; // Blue-500
                ctx.lineWidth = 2;
                ctx.font = '12px Inter';
                ctx.fillStyle = '#1e293b'; // Slate-800

                // Get current positions of entities
                const entityPositions = {};
                dataStore['gegevensmodel-entities'].forEach(entity => {
                    const entityDiv = container.querySelector(`[data-entity-id="${entity.id}"]`);
                    if (entityDiv) {
                        const rect = entityDiv.getBoundingClientRect();
                        const containerRect = container.getBoundingClientRect();
                        entityPositions[entity.id] = {
                            x: rect.left + rect.width / 2 - containerRect.left,
                            y: rect.top + rect.height / 2 - containerRect.top,
                            width: rect.width,
                            height: rect.height
                        };
                    }
                });

                dataStore['gegevensmodel-relationships'].forEach(rel => {
                    const sourcePos = entityPositions[rel.source];
                    const targetPos = entityPositions[rel.target];

                    if (sourcePos && targetPos) {
                        // Calculate start and end points to avoid drawing through entity boxes
                        const startX = sourcePos.x;
                        const startY = sourcePos.y;
                        const endX = targetPos.x;
                        const endY = targetPos.y;

                        // Draw line
                        ctx.beginPath();
                        ctx.moveTo(startX, startY);
                        ctx.lineTo(endX, endY);
                        ctx.stroke();

                        // Draw arrowhead (simple triangle)
                        const angle = Math.atan2(endY - startY, endX - startX);
                        const headLen = 10;
                        ctx.save(); // Save context state before rotating
                        ctx.translate(endX, endY);
                        ctx.rotate(angle);
                        ctx.beginPath();
                        ctx.moveTo(0, 0);
                        ctx.lineTo(-headLen, -headLen / 2);
                        ctx.lineTo(-headLen, headLen / 2);
                        ctx.closePath();
                        ctx.fill();
                        ctx.restore(); // Restore context state

                        // Draw label directly on the line
                        const labelX = (startX + endX) / 2;
                        const labelY = (startY + endY) / 2;
                        
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.font = '12px Inter'; // Ensure font is set for accurate measurement
                        
                        const textMetrics = ctx.measureText(rel.label);
                        const textWidth = textMetrics.width;
                        const textHeight = 14; 
                        
                        // Save current transform to draw text horizontally
                        ctx.save();
                        // Translate to the center of the line
                        ctx.translate(labelX, labelY);
                        // Rotate to align with the line's angle, then rotate back for horizontal text
                        // Adjusting for horizontal text on a diagonal line
                        if (Math.abs(angle) > Math.PI / 2) { // For lines going right-to-left, flip text
                            ctx.rotate(angle + Math.PI);
                        } else {
                            ctx.rotate(angle);
                        }
                        ctx.rotate(-angle); // Rotate back to horizontal
                        
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.8)'; // Semi-transparent white background
                        ctx.fillRect(-textWidth / 2 - 2, -textHeight / 2 - 2, textWidth + 4, textHeight + 4);
                        ctx.fillStyle = '#1e293b'; // Slate-800 for text
                        ctx.fillText(rel.label, 0, 0); // Draw at (0,0) relative to translated context
                        ctx.restore(); // Restore context state after drawing text
                        
                        ctx.fillStyle = '#3b82f6'; // Reset fill for next arrow
                    }
                });
            };


            // Populate dropdowns for relationship management
            const populateRelationshipDropdowns = () => {
                const sourceSelect = document.getElementById('source-entity');
                const targetSelect = document.getElementById('target-entity');
                
                if (!sourceSelect || !targetSelect) return; // Ensure elements exist

                sourceSelect.innerHTML = '<option value="">Selecteer</option>';
                targetSelect.innerHTML = '<option value="">Selecteer</option>';

                dataStore['gegevensmodel-entities'].forEach(entity => {
                    const option1 = document.createElement('option');
                    option1.value = entity.id;
                    option1.textContent = entity.title;
                    sourceSelect.appendChild(option1);

                    const option2 = document.createElement('option');
                    option2.value = entity.id;
                    option2.textContent = entity.title;
                    targetSelect.appendChild(option2);
                });
            };

            // Render existing relationships list
            const renderRelationshipsList = () => {
                const list = document.getElementById('existing-relationships-list');
                if (!list) return;

                list.innerHTML = '';
                dataStore['gegevensmodel-relationships'].forEach((rel, index) => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-slate-50 p-2 rounded-md border border-slate-200';
                    const sourceTitle = dataStore['gegevensmodel-entities'].find(e => e.id === rel.source)?.title || rel.source;
                    const targetTitle = dataStore['gegevensmodel-entities'].find(e => e.id === rel.target)?.title || rel.target;
                    li.innerHTML = `
                        <span>${sourceTitle} --(${rel.label})--> ${targetTitle}</span>
                        <button class="delete-relationship-btn px-2 py-1 text-sm font-medium rounded-md bg-red-500 text-white hover:bg-red-600" data-index="${index}">Verwijder</button>
                    `;
                    list.appendChild(li);
                });

                list.querySelectorAll('.delete-relationship-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const indexToDelete = parseInt(e.target.dataset.index);
                        dataStore['gegevensmodel-relationships'].splice(indexToDelete, 1);
                        renderRelationshipsList();
                        drawRelationships(); // Redraw canvas after deletion
                    });
                });
            };

            // Functie om bewerkmodus in te schakelen voor een sectie
            const enableEditMode = (section) => {
                const sectionId = section.dataset.sectionId;
                section.classList.add('edit-mode');
                
                originalSectionData[sectionId] = {}; 
                lastDeletedNfrItem = null; // Reset undo buffer when entering edit mode
                lastDeletedNfrCategory = null; // Reset undo buffer for categories
                document.querySelectorAll('.undo-nfr-item-btn-container').forEach(container => container.classList.add('hidden'));


                // Sla gewone tekstvelden en lijstitems op
                section.querySelectorAll('[data-key]').forEach(element => {
                    const key = element.dataset.key;
                    // Skip dynamic content handled by dedicated render functions
                    if (key.startsWith('revisie-') || key.startsWith('persona-') || key.includes('-item-') || key.startsWith('entity-') || key.includes('-category-')) {
                        return;
                    }

                    if (key.endsWith('-view')) { 
                        originalSectionData[sectionId][key] = element.innerHTML;
                    } else if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                        // For generic data-key elements that are inputs/textareas
                        const correspondingViewElement = section.querySelector(`.view-mode-elements[data-key="${key}"]`);
                        if (correspondingViewElement) {
                             originalSectionData[sectionId][key] = correspondingViewElement.innerHTML;
                             element.value = correspondingViewElement.innerHTML;
                        } else if (dataStore[key] !== undefined) {
                             originalSectionData[sectionId][key] = dataStore[key];
                             element.value = dataStore[key];
                        }
                    }
                });

                // Special handling for dynamic content
                if (sectionId === 'revisiegeschiedenis') {
                    originalSectionData[sectionId]['revisiegeschiedenis-data'] = JSON.parse(JSON.stringify(dataStore['revisiegeschiedenis-data'])); 
                    renderRevisieTable('edit');
                } else if (sectionId === 'overzicht') {
                    originalSectionData[sectionId]['personas-data'] = JSON.parse(JSON.stringify(dataStore['personas-data']));
                    renderPersonas('edit');
                } else if (sectionId === 'niet-functionele-eisen') {
                    originalSectionData[sectionId]['nfr-categories'] = JSON.parse(JSON.stringify(dataStore['nfr-categories'])); // Deep copy
                    renderNFRCategories('edit'); // Re-render categories in edit mode
                } else if (sectionId === 'gegevensmodel') {
                     originalSectionData[sectionId]['gegevensmodel-entities'] = JSON.parse(JSON.stringify(dataStore['gegevensmodel-entities']));
                     originalSectionData[sectionId]['gegevensmodel-relationships'] = JSON.parse(JSON.stringify(dataStore['gegevensmodel-relationships']));
                     renderEntities('edit');
                     populateRelationshipDropdowns(); // Ensure dropdowns are populated on entering edit mode
                     renderRelationshipsList(); // Render relationships list in edit mode
                }
            };

            // Functie om bewerkmodus uit te schakelen voor een sectie (en op te slaan indien `shouldSave` true is)
            const disableEditMode = (section, shouldSave) => {
                const sectionId = section.dataset.sectionId;
                section.classList.remove('edit-mode');
                lastDeletedNfrItem = null; // Reset undo buffer when exiting edit mode
                lastDeletedNfrCategory = null; // Reset undo buffer for categories
                document.querySelectorAll('.undo-nfr-item-btn-container').forEach(container => container.classList.add('hidden'));

                // Verwerk gewone tekstvelden
                section.querySelectorAll('[data-key]').forEach(element => {
                    const key = element.dataset.key;
                     // Skip dynamic content handled by dedicated save logic
                    if (key.startsWith('revisie-') || key.startsWith('persona-') || key.includes('-item-') || key.startsWith('entity-') || key.includes('-category-')) {
                        return;
                    }
                    if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                        if (shouldSave) {
                            dataStore[key] = element.value;
                        } else if (originalSectionData[sectionId] && originalSectionData[sectionId][key] !== undefined) {
                            element.value = originalSectionData[sectionId][key];
                        }
                    }
                });

                // Special handling for dynamic content saving/restoring
                if (sectionId === 'revisiegeschiedenis') {
                    if (shouldSave) {
                        const updatedRevisieData = [];
                        document.querySelectorAll('#revisie-table-body-edit tr').forEach(row => {
                            const version = row.querySelector(`input[data-key$="-version"]`).value;
                            const date = row.querySelector(`input[data-key$="-date"]`).value;
                            const author = row.querySelector(`input[data-key$="-author"]`).value;
                            const description = row.querySelector(`input[data-key$="-description"]`).value;
                            updatedRevisieData.push({ version, date, author, description });
                        });
                        dataStore['revisiegeschiedenis-data'] = updatedRevisieData;
                    } else if (originalSectionData[sectionId] && originalSectionData[sectionId]['revisiegeschiedenis-data']) {
                        dataStore['revisiegeschiedenis-data'] = JSON.parse(JSON.stringify(originalSectionData[sectionId]['revisiegeschiedenis-data']));
                    }
                } else if (sectionId === 'overzicht') {
                    if (shouldSave) {
                        const updatedPersonas = [];
                        document.querySelectorAll('#personas-container .bg-white.p-4.rounded-lg').forEach((personaDiv, index) => {
                            const name = personaDiv.querySelector(`input[data-key="persona-${index}-name"]`).value;
                            const goals = personaDiv.querySelector(`textarea[data-key="persona-${index}-goals"]`).value;
                            const painpoints = personaDiv.querySelector(`textarea[data-key="persona-${index}-painpoints"]`).value;
                            updatedPersonas.push({ name, goals, painpoints });
                        });
                        dataStore['personas-data'] = updatedPersonas;
                    } else if (originalSectionData[sectionId] && originalSectionData[sectionId]['personas-data']) {
                        dataStore['personas-data'] = JSON.parse(JSON.stringify(originalSectionData[sectionId]['personas-data']));
                    }
                } else if (sectionId === 'niet-functionele-eisen') {
                    if (shouldSave) {
                        const updatedCategories = [];
                        document.querySelectorAll('#nfr-categories-container > div.bg-white').forEach((categoryDiv, catIndex) => {
                            const title = categoryDiv.querySelector(`input[data-key="nfr-category-${catIndex}-title-edit"]`).value;
                            const description = categoryDiv.querySelector(`textarea[data-key="nfr-category-${catIndex}-description"]`).value;
                            const items = [];
                            categoryDiv.querySelectorAll(`textarea[data-key^="nfr-category-${catIndex}-item-"]`).forEach(textarea => { // Correctly select items by category index
                                items.push(textarea.value);
                            });
                            updatedCategories.push({ title, description, items });
                        });
                        dataStore['nfr-categories'] = updatedCategories;
                    } else if (originalSectionData[sectionId] && originalSectionData[sectionId]['nfr-categories']) {
                        dataStore['nfr-categories'] = JSON.parse(JSON.stringify(originalSectionData[sectionId]['nfr-categories']));
                    }
                } else if (sectionId === 'gegevensmodel') {
                    if (shouldSave) {
                        // Save entities
                        const updatedEntities = [];
                        document.querySelectorAll('#entities-container .erd-table').forEach((entityDiv, entityIndex) => {
                            // Fetch data by id, not index
                            const entityId = entityDiv.dataset.entityId; 
                            const title = entityDiv.querySelector(`input[data-key="entity-${entityId}-title"]`).value;
                            const attributes = [];
                            entityDiv.querySelectorAll(`input[data-key^="entity-${entityId}-attribute-"]`).forEach(attrInput => {
                                attributes.push(attrInput.value);
                            });
                            updatedEntities.push({ id: entityId, title, attributes }); // Ensure ID is saved
                        });
                        dataStore['gegevensmodel-entities'] = updatedEntities;
                        // Relationships are already handled by their own add/delete functions so no need to resave here
                    } else if (originalSectionData[sectionId]) {
                        dataStore['gegevensmodel-entities'] = JSON.parse(JSON.stringify(originalSectionData[sectionId]['gegevensmodel-entities']));
                        dataStore['gegevensmodel-relationships'] = JSON.parse(JSON.stringify(originalSectionData[sectionId]['gegevensmodel-relationships']));
                    }
                }
                
                if (shouldSave) {
                    localStorage.setItem('foTemplateData', JSON.stringify(dataStore));
                }
                loadContent(); 
                delete originalSectionData[sectionId]; 
            };

            // Functie voor toevoegen nieuwe rij in revisiegeschiedenis
            document.getElementById('add-revisie-row').addEventListener('click', () => {
                dataStore['revisiegeschiedenis-data'].push({ version: '', date: '', author: '', description: '' });
                renderRevisieTable('edit');
            });

            // Functie voor toevoegen nieuwe persona
            document.getElementById('add-persona-btn').addEventListener('click', () => {
                dataStore['personas-data'].push({ name: '', goals: '', painpoints: '' });
                renderPersonas('edit');
            });

            // Functie voor toevoegen nieuw NFR item
            document.body.addEventListener('click', (e) => {
                if (e.target.classList.contains('add-nfr-item-btn')) {
                    const nfrCatIndex = parseInt(e.target.dataset.nfrCategoryIndex);
                    dataStore['nfr-categories'][nfrCatIndex].items.push(''); 
                    renderNFRItemsList(nfrCatIndex, 'edit');
                }
            });

            // Functie voor het ongedaan maken van de laatste NFR item verwijdering
            document.querySelectorAll('.undo-nfr-item-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    if (lastDeletedNfrItem) {
                        const { nfrKey, index, itemContent } = lastDeletedNfrItem;
                        dataStore['nfr-categories'][nfrKey].items.splice(index, 0, itemContent); 
                        renderNFRItemsList(nfrKey, 'edit');
                        lastDeletedNfrItem = null; 
                        e.target.parentElement.classList.add('hidden'); 
                    }
                });
            });

            // Functie voor toevoegen nieuwe NFR categorie
            document.getElementById('add-nfr-category-btn').addEventListener('click', () => {
                dataStore['nfr-categories'].push({ 
                    title: 'Nieuwe Categorie', 
                    description: 'Beschrijving van de nieuwe categorie.', 
                    items: ['Nieuw item 1', 'Nieuw item 2'] 
                });
                renderNFRCategories('edit');
            });

            // Functie voor toevoegen nieuwe entiteit (gegevensmodel)
            document.getElementById('add-entity-btn').addEventListener('click', () => {
                const newId = `entity-${Date.now()}`; // Generate a unique ID
                dataStore['gegevensmodel-entities'].push({ id: newId, title: 'Nieuwe Entiteit', attributes: [''] });
                renderEntities('edit');
                populateRelationshipDropdowns(); // Update dropdowns
            });

            // Add Relationship Button Event Listener
            document.getElementById('add-relationship-btn').addEventListener('click', () => {
                const sourceEntityId = document.getElementById('source-entity').value;
                const targetEntityId = document.getElementById('target-entity').value;
                const label = document.getElementById('relationship-label').value;

                if (sourceEntityId && targetEntityId && label) {
                    dataStore['gegevensmodel-relationships'].push({
                        source: sourceEntityId,
                        target: targetEntityId,
                        label: label,
                        bidirectional: false // Default to unidirectional, user can manually change label if bidirectional
                    });
                    renderRelationshipsList();
                    drawRelationships();
                    document.getElementById('relationship-label').value = ''; // Clear label
                    document.getElementById('source-entity').value = ''; // Clear source
                    document.getElementById('target-entity').value = ''; // Clear target
                } else {
                    alert('Selecteer een bron- en doelentiteit en voer een label in.');
                }
            });


            // Voeg event listeners toe voor bewerk/opslaan/annuleren knoppen van secties
            document.querySelectorAll('.editable-section').forEach(section => {
                const editBtn = section.querySelector('.edit-btn');
                const saveBtn = section.querySelector('.save-btn');
                const cancelBtn = section.querySelector('.cancel-btn');

                editBtn.addEventListener('click', () => enableEditMode(section));
                saveBtn.addEventListener('click', () => disableEditMode(section, true));
                cancelBtn.addEventListener('click', () => disableEditMode(section, false));
            });

            // Functional Requirements Toggle
            const showUserStoriesBtn = document.getElementById('show-user-stories');
            const showUseCasesBtn = document.getElementById('show-use-cases');
            const userStoriesContent = document.getElementById('user-stories-content');
            const useCasesContent = document.getElementById('use-cases-content');

            showUserStoriesBtn.addEventListener('click', () => {
                userStoriesContent.classList.remove('hidden');
                useCasesContent.classList.add('hidden');
                showUserStoriesBtn.classList.add('bg-sky-600', 'text-white');
                showUserStoriesBtn.classList.remove('bg-white', 'border', 'border-slate-300', 'text-slate-700');
                showUseCasesBtn.classList.add('bg-white', 'border', 'border-slate-300', 'text-slate-700');
                showUseCasesBtn.classList.remove('bg-sky-600', 'text-white');
            });

            showUseCasesBtn.addEventListener('click', () => {
                useCasesContent.classList.remove('hidden');
                userStoriesContent.classList.add('hidden');
                showUseCasesBtn.classList.add('bg-sky-600', 'text-white');
                showUseCasesBtn.classList.remove('bg-white', 'border', 'border-slate-300', 'text-slate-700');
                showUserStoriesBtn.classList.add('bg-white', 'border', 'border-slate-300', 'text-slate-700');
                showUserStoriesBtn.classList.remove('bg-sky-600', 'text-white');
            });
            
            // Accordeon voor NFR categorieën (geeft toggle functionaliteit aan de koppen)
            // Deze moet nu worden toegevoegd aan de dynamisch gegenereerde elementen in renderNFRCategories
            // via event delegation of door de listener direct toe te voegen na het maken van de knoppen.
            // Dit is nu geïmplementeerd in renderNFRCategories

            // Zijbalk Actieve Status bij Scrollen
            const sections = document.querySelectorAll('section');
            const navLinks = document.querySelectorAll('#sidebar-nav a');
            
            const activateLink = (id) => {
                 navLinks.forEach(link => {
                    link.classList.remove('active');
                    if(link.getAttribute('href') === `#${id}`) {
                        link.classList.add('active');
                    }
                });
            };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        activateLink(entry.target.id);
                    }
                });
            }, { rootMargin: '-30% 0px -70% 0px', threshold: 0 });

            sections.forEach(section => {
                observer.observe(section);
            });
            
            // Functie om data te downloaden als JSON
            const downloadData = () => {
                const dataStr = JSON.stringify(dataStore, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'functioneel_ontwerp_data.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            // Functie om data te uploaden vanaf een JSON-bestand
            const uploadData = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const uploadedData = JSON.parse(e.target.result);
                            // Merge uploaded data with existing, allowing it to override
                            Object.keys(uploadedData).forEach(key => {
                                dataStore[key] = uploadedData[key];
                            });
                            localStorage.setItem('foTemplateData', JSON.stringify(dataStore));
                            loadContent(); // Herlaad de content in de browser
                            alert('Bestand succesvol geladen!');
                        } catch (error) {
                            alert('Fout bij het lezen van het bestand: ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                }
            };

            // Functie om de pagina als HTML te exporteren
            const exportHtml = () => {
                // Ensure all editable sections are in view mode before export
                document.querySelectorAll('.editable-section.edit-mode').forEach(section => {
                    disableEditMode(section, false); // Cancel any ongoing edits
                });

                const htmlContent = document.documentElement.outerHTML;
                const blob = new Blob([htmlContent], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'functioneel_ontwerp.html';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            // Functie om de pagina te printen / als PDF op te slaan
            const printPdf = () => {
                 // Ensure all editable sections are in view mode before print
                document.querySelectorAll('.editable-section.edit-mode').forEach(section => {
                    disableEditMode(section, false); // Cancel any ongoing edits
                });
                window.print();
            };


            // Voeg event listeners toe aan de download en upload knoppen
            document.getElementById('download-btn').addEventListener('click', downloadData);
            document.getElementById('upload-btn').addEventListener('click', () => {
                document.getElementById('upload-input').click();
            });
            document.getElementById('upload-input').addEventListener('change', uploadData);
            document.getElementById('export-html-btn').addEventListener('click', exportHtml);
            document.getElementById('print-pdf-btn').addEventListener('click', printPdf);

            // Zorg ervoor dat de content correct wordt geladen bij de start
            loadContent();

            // Handle window resize to redraw relationships
            window.addEventListener('resize', () => {
                // Only redraw if not in print mode (window.matchMedia('print').matches)
                if (!window.matchMedia('print').matches) {
                    drawRelationships();
                }
            });
        });
    </script>
</body>
</html>
